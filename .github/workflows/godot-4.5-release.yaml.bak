name: Godot 4.5 - Release arkanoid-simple
on:
  push:
    branches: [ main ]
    tags: [ 'release' ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  GODOT_VERSION: "4.5.1-stable" 

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Cache export templates
        uses: actions/cache@v4
        with:
          path: ~/.local/share/godot/export_templates
          key: godot-templates-${{ env.GODOT_VERSION }}-${{ runner.os }}

      - name: Install prerequisites
        run: sudo apt-get update && sudo apt-get install -y wget unzip

      - name: Download Godot headless 4.5 and export templates (if missing)
        run: |
          mkdir -p tools
          # Godot headless (editor) binary
          if [ ! -f tools/godot ]; then
            wget -q -O tools/godot.zip "https://downloads.tuxfamily.org/godotengine/4.5/Godot_v4.5-stable_linux_headless.64.zip" || true
            unzip -o tools/godot.zip -d tools || true
            chmod +x tools/godot || true
          fi
          # Export templates (tpz) - official mirrors (SourceForge/Godot site)
          if [ ! -d ~/.local/share/godot/export_templates ]; then
            wget -q -O templates.tpz "https://sourceforge.net/projects/godot-engine.mirror/files/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz/download"
            mkdir -p ~/.local/share/godot/export_templates
            tar -xvf templates.tpz -C ~/.local/share/godot/export_templates || unzip templates.tpz -d ~/.local/share/godot/export_templates || true
          fi

      - name: Verify export_presets and templates
        run: |
          if ! grep -q "export_presets.cfg" -s .; then echo "Missing export_presets.cfg" && exit 1; fi
          ls -la ~/.local/share/godot/export_templates

      - name: Create build dirs
        run: mkdir -p $BUILD_DIR/{html5,linux,windows,android}

      - name: Export HTML5
        run: ./tools/godot --export "HTML5" $BUILD_DIR/html5/index.html

      - name: Export Linux
        run: ./tools/godot --export "Linux/X11" $BUILD_DIR/linux/game.x86_64

      - name: Export Windows
        run: ./tools/godot --export "Windows Desktop" $BUILD_DIR/windows/game.exe

      - name: Prepare Android keystore
        if: ${{ secrets.ANDROID_KEYSTORE_B64 != '' }}
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: |
          mkdir -p android
          echo "$KEYSTORE_B64" | base64 -d > android/release.keystore

      - name: Export Android
        run: ./tools/godot --export "Android" $BUILD_DIR/android/game.apk

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-builds
          path: ${{ env.BUILD_DIR }}

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/tags/release' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: godot-builds
          path: downloaded_build

      - name: Install butler
        run: |
          curl -L https://broth.itch.ovh/butler/linux-amd64/head/archive/default -o butler
          chmod +x butler

      - name: Push to itch.io (html5/windows/linux)
        env:
          ITCHIO_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
          ITCHIO_USER: ${{ secrets.ITCHIO_USER }}
          ITCHIO_GAME: ${{ secrets.ITCHIO_GAME }}
        run: |
          export BUTLER_CREDENTIALS="$ITCHIO_API_KEY"
          ./butler push downloaded_build/html5 "$ITCHIO_USER/$ITCHIO_GAME:html5" --userversion "${GITHUB_SHA}"
          ./butler push downloaded_build/windows "$ITCHIO_USER/$ITCHIO_GAME:windows" --userversion "${GITHUB_SHA}"
          ./butler push downloaded_build/linux "$ITCHIO_USER/$ITCHIO_GAME:linux" --userversion "${GITHUB_SHA}"
