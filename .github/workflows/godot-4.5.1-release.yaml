name: Godot 4.5.1 CI and Export

on:
  push:
    branches: [main]
    tags: ["release"]
  workflow_dispatch:
env:
  BUILD_DIR: build
  GODOT_VERSION: "4.5.1-stable"

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use godot-ci image
        uses: docker://barichello/godot-ci:4.5
        with:
          entrypoint: /bin/bash
        run: |
          # inside container context via docker action; fallback to running commands below

      - name: Setup Godot export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          # Si usas godot-ci container esto ya viene preparado; si no, descarga templates compatibles con 4.5

      - name: Run optional tests and lint
        run: |
          # Ejecuta tus tests headless si los tienes
          godot --headless --script ci/run_tests.gd || true

      - name: Export HTML5
        run: godot --export "HTML5" build/html5/index.html

      - name: Export Linux
        run: godot --export "Linux/X11" build/linux/game.x86_64

      - name: Export Windows
        run: godot --export "Windows Desktop" build/windows/game.exe

      - name: Prepare Android keystore
        if: secrets.ANDROID_KEYSTORE_B64 != ''
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: |
          echo "$KEYSTORE_B64" | base64 -d > android/release.keystore
          # Ajusta gradle/jar signing en export_presets.cfg si es necesario

      - name: Export Android
        run: godot --export "Android" build/android/game.apk

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-builds
          path: build/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: build/**

      - name: Install butler and push to itch.io
        env:
          ITCHIO_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
          ITCHIO_USER: ${{ secrets.ITCHIO_USER }}
          ITCHIO_GAME: ${{ secrets.ITCHIO_GAME }}
        run: |
          curl -L https://broth.itch.ovh/butler/linux-amd64/head/archive/default -o butler
          chmod +x butler
          ./butler push build/html5 "$ITCHIO_USER/$ITCHIO_GAME:html5" --userversion $GITHUB_SHA
          ./butler push build/windows "$ITCHIO_USER/$ITCHIO_GAME:windows" --userversion $GITHUB_SHA
